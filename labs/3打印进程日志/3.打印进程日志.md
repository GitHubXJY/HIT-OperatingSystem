# 打印进程日志

## 实验内容

本次实验将进程在其整个生存周期（进程从创建到结束）中的运行轨迹记录下来，进程在其生命周期中的运行轨迹实际上表现为进程状态的多次切换，即记录每个进程的每次状态切换。

进程日志记录在`/var/process.log`文件中，其格式为`pid    X   time`。其中`pid`是进程ID；`X`是N（进程新建）、J（进入就绪态）、R（进入运行态）、W（进入阻塞态）和E（进程退出）中的任意一个；`time`表示状态切换时发生的时间，这个时间不是物理时间，而是系统的滴答时间(tick)，即开机以后经过的滴答数。

为了能尽早开始记录，应当在内核启动时就打开日志文件，更准确的说：在进程0开始在用户态执行以后就打开日志文件，因为这个时候已经开启了多进程试图。由系统启动的知识可知，这个时间点在语句`move_to_user_mode()`后面。虽然这是最合适的记录位置，但此时文件系统还没有挂载，所有现在还不能记录。

文件`~/init/main.c`中的`main`函数执行语句：

```C++
void main(void){
    ......
    move_to_user_mode();
    if(!fork()) {init();}
}
```

其中`init()`函数主要以下工作：

```C++
void init(void){
setup((void*)& drive_info);
    (void) open("/dev/tty0",O_RDONLY,0);
    (void) dup(0);
    (void) dup(0);
    ......
}
```

其中第一条语句完成文件系统的加载，第二三四条语句打开标准输入、标准输出和标准错误三个文件，分别对应stdin、stdout和stderr。此时打开日志文件正合适：

```C++
(void) open("/var/process.log",O_CREAT|O_TRUNC|O_WRONLY,0666)
```

将上述打开日志文件的语句和上述`init()`函数中四条语句移动到`move_to_user_mode()`之后，这样一旦0号进程切换到用户态，即多进程视图刚出现就可以开始记录了。

## 实验流程
