# æ·»åŠ ç³»ç»Ÿè°ƒç”¨

## å®éªŒå†…å®¹

æ·»åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨`iam`å’Œ`whoami`ï¼Œå¹¶ç¼–å†™ç®€å•çš„åº”ç”¨ç¨‹åºè¿›è¡Œæµ‹è¯•ã€‚

æ·»åŠ ç³»ç»Ÿè°ƒç”¨ iamï¼Œå…¶å‡½æ•°åŸå‹ä¸ºï¼š`int iam(const char* name);` å®Œæˆçš„åŠŸèƒ½æ˜¯å°†å­—ç¬¦ä¸²å‚æ•° nameçš„å†…å®¹å¤åˆ¶åˆ°å†…æ ¸ä¸­å¹¶ä¿å­˜ä¸‹æ¥ã€‚è¦æ±‚ nameçš„é•¿åº¦ä¸è¶…è¿‡ 23ä¸ªå­—ç¬¦ï¼Œè¿”å›å€¼æ˜¯å®é™…å¤åˆ¶çš„å­—ç¬¦æ•°ã€‚å¦‚æœ nameçš„å­—ç¬¦ä¸ªæ•°è¶…è¿‡äº† 23åˆ™è¿”å› -1ï¼Œå¹¶ç½® errnoä¸º EINVALã€‚

æ·»åŠ ç³»ç»Ÿè°ƒç”¨ whoamiï¼Œå…¶å‡½æ•°åŸå‹æ˜¯ï¼š`int whoami(char* name,unsigned int size);` è¯¥ç³»ç»Ÿè°ƒç”¨å°†å†…æ ¸ä¸­ç”± iam()ä¿å­˜çš„åå­—å¤åˆ¶åˆ° nameæŒ‡å‘çš„ç”¨æˆ·ç©ºé—´ä¸­ï¼ŒåŒæ—¶ç¡®ä¿ä¸ä¼šå¯¹ nameè¶Šç•Œè®¿é—®ï¼ˆnameçš„å¤§å°ç”± sizeè¯´æ˜ï¼‰ã€‚è¿”å›å€¼æ˜¯å¤åˆ¶çš„å­—ç¬¦ä¸ªæ•°ï¼Œå¦‚æœ sizeå°äºéœ€è¦çš„ç©ºé—´åˆ™è¿”å› -1ï¼Œå¹¶ç½® errnoä¸º EINVALã€‚

æµ‹è¯•ç¨‹åºæ˜¯ç¼–å†™ä¸¤ä¸ªç”¨æˆ·æ€æµ‹è¯•ç¨‹åº iam.cå’Œ whoami.cï¼Œå…¶ä¸­ iam.cè¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨ iamè®¾ç½®å†…æ ¸ä¸­çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œ whoami.cåˆ™é€šè¿‡ç³»ç»Ÿè°ƒç”¨ whoamiæ¥å–å‡ºè¿™ä¸ªå†…æ ¸å­—ç¬¦ä¸²ï¼Œå¹¶ç”¨ printfåœ¨å±å¹•ä¸Šè¾“å‡ºï¼Œæœ€ç»ˆçš„è¿è¡Œç»“æœæ˜¯ï¼š

```bash
[usr/root]# ./iam xxx
[usr/root]# ./whoami
xxx
```

ç³»ç»Ÿè°ƒç”¨å‡½æ•°é¦–å…ˆè¦å±•å¼€æˆä¸€æ®µä»£ç ï¼šæŠŠç³»ç»Ÿè°ƒç”¨çš„ç¼–å·å­˜å…¥å¯„å­˜å™¨eaxä¸­ï¼›æŠŠå‡½æ•°å‚æ•°å­˜å…¥å…¶å®ƒé€šç”¨å¯„å­˜å™¨ï¼›å†è§¦å‘ 0x80å·ä¸­æ–­ï¼Œè€Œè¿™ä¸ªåŠŸèƒ½æ˜¯ä¾é  Cå‡½æ•°åº“æä¾›çš„ syscallå®å±•å¼€çš„ï¼Œæ‰€ä»¥ int iam(const char* name)è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¹Ÿéœ€è¦ç”¨è¿™ä¸ªå®å±•å¼€æˆè§¦å‘ 0x80ä¸­æ–­çš„ä¸€æ®µä»£ç ã€‚

```C
// iamç³»ç»Ÿè°ƒç”¨å£°æ˜ä»£ç å’Œå®å±•å¼€
#define __NR_iam 72
syscall1(int,iam,const char*,name)
```

å®__NR_iamç”¨æ¥å®šä¹‰ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼Œå°†æ¥è¦å­˜å…¥eaxä¸­ï¼ˆlinux0.11æœ¬èº«æœ‰ 72ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä½†ä» 0å¼€å§‹ç¼–å·ï¼‰ã€‚ä¸Šé¢ä¸¤å¥ iamç³»ç»Ÿè°ƒç”¨ç”³æ˜ä»£ç å¯ä»¥æ”¾åœ¨ iam.cæ–‡ä»¶å¤´éƒ¨ä¹Ÿå¯ä»¥æ”¾åœ¨ include/unistd.hæ–‡ä»¶ä¸­ï¼Œä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œç°åœ¨ iam.cä¸­çš„ main()å‡½æ•°å¯ä»¥è°ƒç”¨ iam()äº†ï¼Œå› ä¸ºå·²ç»æœ‰äº† iamå‡½æ•°çš„å®ç°ï¼Œå³ int iam(const char* name){...;int 0x80;...}ã€‚

ç°åœ¨ iam()å¯ä»¥å˜æˆ "int 0x80" è¿›å…¥å†…æ ¸äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ int 0x80è§¦å‘åå†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†äº†ï¼Œä¸­æ–­å¤„ç†è¿‡ç¨‹æœ€ç»ˆè·³è½¬åˆ° system_callå‡½æ•°ã€‚system_callçš„ç¬¬ä¸€å¥æ˜¯ä¸€ä¸ªå®å®šä¹‰ nr_system_call=72ï¼Œè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¾ç„¶ç°åœ¨è¿™é‡Œåº”è¯¥æ”¹æˆ73ã€‚system_callçš„æ ¸å¿ƒä½œç”¨æ˜¯é€šè¿‡ call sys_call_table(,%eax,4)è·³è½¬åˆ°å‡½æ•°åœ°å€è¡¨ sys_call_tableä¸­çš„æŸä¸ªé¡¹ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ eax=73å¯¹åº”çš„é‚£ä¸€é¡¹ã€‚æ‰¾åˆ°å‡½æ•°è¡¨ fn_ptr sys_call_table[]={......}ï¼Œåœ¨è¿™ä¸ªå‡½æ•°è¡¨çš„ç¬¬ 73é¡¹æ·»åŠ å†…æ ¸å‡½æ•° sys_iam()çš„åœ°å€åï¼Œå°±å¯ä»¥ä»ç”¨æˆ·æ€çš„ iam()æ¥è°ƒç”¨ sys_iam()äº†ã€‚

æ¥ä¸‹æ¥è¦åœ¨å†…æ ¸ä¸­å®ç°å‡½æ•° sys_iam()ï¼Œæ“ä½œç³»ç»Ÿä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„å®ç°å‡½æ•°å¯ä»¥å­¦ä¹ æ¨¡ä»¿ï¼Œå¦‚ fs/open.cä¸­çš„ sys_close(int fd)çš„ä»£ç ã€‚åˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿæ–‡ä»¶ kernel/who.cï¼Œåœ¨å…¶ä¸­å®ç°å†…æ ¸å‡½æ•° sys_iam()ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```C
// sys_iam æ ¸å¿ƒä»£ç 
char kernel_name[23];
int sys_iam(char* name){
    ......
    char c=get_fs_byte(&name);
    kernel_name[0]=c;
    ......
}
```

sys_iam()çš„å·¥ä½œæ˜¯ï¼šç”¨ get_fs_byte()ä» nameæŒ‡å‘çš„å†…å­˜ç¼“å­˜åŒºä¸­è·å–æ•°æ®ï¼Œç„¶åå°†è¿™äº›æ•°æ®æŒ‰å­—èŠ‚é€ä¸ªå­˜æ”¾åˆ°å†…æ ¸ç¼“å­˜åŒº kernel_nameä¸­ã€‚ç”¨ get_fs_byte()æ¥è·å–æ•°æ®è€Œä¸æ˜¯ç”¨ c=*(name+i)è·å– nameæ•°ç»„ä¸­çš„ç¬¬ iä¸ªæ•°æ®çš„åŸå› æ˜¯ï¼šæ“ä½œç³»ç»Ÿä¸­çš„æ¯ä¸ªåœ°å€éƒ½ç”± "æ®µï¼šåç§»" æ„æˆï¼Œå¦‚æœåªå†™ name+iï¼Œåˆ™åªç»™å‡ºäº†åç§»ï¼Œä¼šä½¿ç”¨é»˜è®¤çš„æ®µå¯„å­˜å™¨DSï¼Œè€Œ system_callçš„ä»£ç ä¸­ DS=0x10ï¼Œå¯¹åº”çš„æ˜¯å†…æ ¸æ®µï¼Œè¿™æ ·åœ¨å†…æ ¸ä¸­æ²¡æœ‰ nameè¿™ä¸ªåœ°å€ã€‚nameä¸­å­˜æ”¾çš„ "xxx" æ˜¯ä¸€æ®µç”¨æˆ·æ€å†…å­˜ç¼“å­˜åŒºï¼Œæ‰€ä»¥è¿™é‡Œåªèƒ½ä½¿ç”¨ FSä½œä¸ºæ®µå¯„å­˜å™¨æ‰èƒ½æ‰¾åˆ°è¿™ä¸ªç”¨æˆ·æ€å†…å­˜ç¼“å­˜åŒºï¼ˆFSè¢«è®¾ç½®æˆ 0x17ï¼‰ã€‚

get_fs_byte()ç”¨æ¥ä»ç”¨æˆ·æ€å†…å­˜ç¼“å­˜åŒºä¸­å–å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œæ”¾åˆ°å†…æ ¸ç¼“å­˜åŒºä¸­ï¼Œå…¶ä»£ç å®ç°ä¸ºï¼š

```C
// get_fs_byte ä»£ç å®ç°
extern inline unsigned char get_fs_byte(const char* addr){
    unsigned register char _v;
    __asm__("movb %%fs:%1,%0":"=r"(_v):"m"(*addr));
    return _v;
}
```

ç°åœ¨åœ¨ç›¸åº”ä½ç½®æœ‰äº†ç³»ç»Ÿè°ƒç”¨ iamçš„å£°æ˜ï¼Œsys_call_table[]è¡¨é‡Œå¢åŠ äº† sys_iamçš„åœ°å€ï¼Œåœ¨ kernel/who.cä¸­å®ç°äº† sys_iam()ï¼ˆå†…æ ¸å‡½æ•°ã€ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œæ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹ Makefileï¼Œè®©æ–°æ·»åŠ çš„æ“ä½œç³»ç»Ÿæ–‡ä»¶å¯ä»¥å’Œå…¶å®ƒæ–‡ä»¶ç¼–è¯‘é“¾æ¥åˆ°ä¸€èµ·ã€‚ç„¶åé‡æ–°ç¼–è¯‘æ“ä½œç³»ç»Ÿæºç ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿé•œåƒæ–‡ä»¶ï¼Œç”¨è¿™ä¸ªé•œåƒæ–‡ä»¶å¯åŠ¨ Bochså¼•å¯¼å‡ºæ“ä½œç³»ç»Ÿï¼Œåœ¨è¿™ä¸ªæ“ä½œç³»ç»Ÿä¸Šç¼–å†™ä¸€ä¸ª iam.cç”¨æˆ·æ€ç¨‹åºï¼Œåœ¨å…¶ä¸­åŠ ä¸Š #define __NR_iam 72å’Œå®å±•å¼€ _syscall1(int,iam,const char*,name)ï¼ˆ_syscall*å®å±•å¼€ç³»ç»Ÿè°ƒç”¨ï¼Œæä¾›ç”¨æˆ·æ€çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼‰ï¼Œå¹¶åœ¨ iam.cçš„ main()å‡½æ•°ä¸­è°ƒç”¨ iamç³»ç»Ÿè°ƒç”¨ï¼Œå°±èƒ½å®ç°å®éªŒé¡¹ç›®çš„è¦æ±‚äº†ã€‚

ç³»ç»Ÿè°ƒç”¨ whoamiçš„å®ç°æµç¨‹å’Œä½ç½®ä¸ç³»ç»Ÿè°ƒç”¨ iamç›¸åŒã€‚ä»å†…æ ¸ç¼“å­˜åŒºè·å–æ•°æ®æ”¾åˆ°ç”¨æˆ·ç¼“å­˜åŒºçš„å‡½æ•°æ˜¯`put_fs_byte(FROM,TO)`ã€‚

## å®éªŒæµç¨‹

1. ä¿®æ”¹ linux-0.11 æºæ–‡ä»¶

>æ‰€æœ‰æ–‡ä»¶è·¯å¾„å‡åœ¨ linux-0.11 ç›®å½•ä¸‹

åœ¨æ–‡ä»¶ include/unistd.hä¸­çš„ 72ä¸ªç³»ç»Ÿè°ƒç”¨å£°æ˜åé¢æ·»åŠ ç³»ç»Ÿè°ƒç”¨ iamå’Œ whoamiçš„å£°æ˜ä»£ç ï¼š

```C
// ï¼ˆæœ‰72ä¸ªï¼Œä½†ä»0å¼€å§‹ç¼–å·ï¼‰
#define __NR_iam    72
#define __NR_whoami 73
```

åœ¨æ–‡ä»¶ kernel/system_call.sä¸­ï¼Œå°†ï¼š

```C
nr_system_calls=72
# æ”¹ä¸º
nr_system_calls=74
```

åœ¨æ–‡ä»¶ include/linux/sys.hä¸­ï¼Œåœ¨72ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°å£°æ˜åé¢åŠ å…¥ä¸¤è¡Œï¼š

```C
extern int sys_iam();
extern int sys_whoami();
```

å¹¶åœ¨å‡½æ•°æŒ‡é’ˆè¡¨ sys_call_table[]çš„æœ«å°¾åŠ å…¥ï¼š`sys_iam` å’Œ `sys_whoami`ï¼ˆæ³¨æ„é¡ºåºå’Œä¸Šé¢çš„å£°æ˜è¦ç›¸åŒï¼‰ã€‚

æ–°å»ºä¸€ä¸ªæ–‡ä»¶ kernel/who.cï¼Œåœ¨å…¶ä¸­å®ç°ç³»ç»Ÿè°ƒç”¨ iamå’Œ whoamiã€‚å³å®ç°å†…æ ¸å‡½æ•° sys_iam()å’Œ sys_whoami()ã€‚

```C

// linux/kernel/who.c
#include <string.h>
#include <errno.h>
#include <asm/segment.h>    // for function get_fs_byte() and put_fs_byte()

// ç”¨å…¨å±€å˜é‡å­˜å‚¨
char _k_name[24];   // 23 + '\0' = 24
int _k_length;

int sys_iam(char* name){
    // printk("sys_iam\n"); // å†…æ ¸ä¸­åªèƒ½ç”¨printkï¼ˆè€Œéprintfï¼‰
    int name_len=0;
    while(get_fs_byte(&name[i])!='\0'){
        name_len++;
    }
    if(name_len>23){
        // _syscall*ä¸­ä¼šå¯¹å‡ºé”™æ—¶çš„è¿”å›å€¼å–åï¼Œæ‰€ä»¥è¿™é‡Œå…ˆå–åï¼Œå¦åˆ™ä¼šå¾—åˆ°ç›¸åå€¼
        return -EINVAL; 
    }
    int i=0;    // Bochs ä¸æ”¯æŒåœ¨forå¾ªç¯ä¸­å®šä¹‰å˜é‡
    for(;i<name_len;i++){
        _k_name[i]=get_fs_byte(&name[i]);
    }
    _k_length=name_len;
    return name_len;
}

int sys_whoami(char* name,unsigned int size){
    // printk("sys_whoami\n");
    if(_k_length>size){
        return -EINVAL;
    }
    int i=0;
    for(;i<_k_length;i++){
        put_fs_byte(_k_name[i],&name[i]);
    }
    return _k_length;
}

```

æ¥ä¸‹æ¥ä¿®æ”¹ kernel/Makefileï¼šåœ¨`OBJS`ä¸­æ·»åŠ ä¾èµ–`who.o`ï¼›åœ¨`Dependencies`ä¸­æ·»åŠ `who.s`å’Œ`who.o`çš„ä¾èµ–äº§ç”Ÿæ¡ä»¶ã€‚

![alt](./pictures/201.png)

æ¥ä¸‹æ¥æŒ‰ç…§ä¹‹å‰çš„æ–¹å¼`make all`ï¼Œå†æ‰§è¡Œ`./run`è¿è¡Œ linux0.11å­ç³»ç»Ÿã€‚

2. åœ¨ Bochså†…

> æ‰€æœ‰ä¿®æ”¹è¿è¡Œéƒ½åœ¨è¿è¡Œ linux0.11çš„ Bochsä¸­è¿›è¡Œ

åœ¨æ–‡ä»¶`usr/include/unistd.h`ä¸­å¢åŠ `iam`å’Œ`whoami`çš„å®å®šä¹‰ï¼š

![alt](./pictures/202.png)

æ¥ä¸‹æ¥ç¼–å†™æµ‹è¯•æ–‡ä»¶`iam.c`å’Œ`whoami.c`

```C
// æµ‹è¯•æ–‡ä»¶ iam.cçš„ä»£ç 
#define __LIBRARY__     // for _syscall*
#include<unistd.h>      // for ç¼–è¯‘å™¨è·çŸ¥è‡ªå®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·

_syscall1(int,iam,char*,name);  // å®å±•å¼€

int main(int argc,char** argv){
    iam(argv[1]);
    return 0;
}
```

```C
// æµ‹è¯•æ–‡ä»¶ whoami.cçš„ä»£ç 
#define __LIBRARY__     // for _syscall*
#include<unistd.h>      // for ç¼–è¯‘å™¨è·çŸ¥è‡ªå®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·
#include<stdio.h>äººä»¬

_syscall2(int,whoami,char*,name,unsigned int,size); // å®å±•å¼€

int main(){
    char s[24];
    whoami(s,24);
    printf("s\n",s);
    return 0;
}
```

åœ¨è¿è¡Œ linux0.11çš„ Bochsä¸­ç¼–è¯‘`iam.c`å’Œ`whoami.c`ã€‚

```bash
gcc -o iam iam.c -Wall
gcc -o whoami whoami.c -Wall
```

![alt](./pictures/203.png)

è¿è¡Œ`iam`å’Œ`whoami`ï¼š

![alt](./pictures/204.png)

ğŸ†— (\^_^) ğŸ†—
